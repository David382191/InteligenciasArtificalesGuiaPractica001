# =========================
# ğŸ’¾ FUNCIÃ“N PARA CONSUMIR LA API
# =========================
@st.cache_data
def get_data(year, region, tipo):
    url = 
    params = {
        "year": year,
        "region": region,
        "type": tipo
    }

    # ğŸ‘‡ Esto nos sirve para depurar
    st.write("ğŸ”— URL generada:", url)
    st.write("ğŸ“¦ ParÃ¡metros enviados:", params)

    response = requests.get(url, params=params)
    st.write("ğŸ“¡ CÃ³digo de respuesta HTTP:", response.status_code)
    st.write("ğŸ“ƒ Texto de respuesta:", response.text[:500])  # solo 500 caracteres

    if response.status_code == 200:
        try:
            data = response.json()
            df = pd.DataFrame(data)
            return df
        except Exception as e:
            st.error(f"âŒ Error al convertir JSON: {e}")
            return pd.DataFrame()
    else:
        st.error(f"âŒ Error {response.status_code}: No se pudo obtener la data")
        return pd.DataFrame()


# =========================
# ğŸ“‚ ALTERNATIVA CON CSV (si no hay API)
# =========================
@st.cache_data
def load_csv():
    try:
        return pd.read_csv("contrataciones.csv")
    except FileNotFoundError:
        st.warning("âš ï¸ No se encontrÃ³ el archivo CSV. Solo se usarÃ¡ la API.")
        return pd.DataFrame()

# =========================
# ğŸ“Š MOSTRAR RESULTADOS
# =========================
if buscar:
    df = get_data(year, region, tipo)

    if df.empty:
        # Intentar con CSV si la API falla
        df = load_csv()
        if not df.empty:
            df = df[
                (df["year"] == year) &
                (df["region"] == region) &
                (df["type"] == tipo)
            ]

    if not df.empty:
        st.success("âœ… Datos cargados correctamente")
        st.dataframe(df)

        # PequeÃ±a estadÃ­stica como ejemplo
        st.subheader("ğŸ“ˆ EstadÃ­sticas rÃ¡pidas")
        st.write(df.describe())
    else:
        st.error("âŒ No se encontraron datos para los filtros seleccionados.")
